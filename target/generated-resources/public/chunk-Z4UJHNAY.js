import{a as _,b as se}from"./chunk-M6ZSIYLJ.js";import{E as lt,J as ie,K as Q,L as T,M as F,N as R,O as oe,P as tt,j as Y,n as ee,s as Tt}from"./chunk-GBVWTJHZ.js";import{J as Yt,ja as Qt,ka as te,ma as V}from"./chunk-NFY77JBK.js";import"./chunk-HBCL52P7.js";import{k as Jt}from"./chunk-OG6B6UFA.js";import{Od as qt,aa as J,ba as Ht,ca as $t,ee as Xt,y as rt}from"./chunk-HA3FE6NY.js";import{A as v,C as Zt,D as Vt,Eh as Z,J as Kt,Lg as Wt,S as kt,Z as Lt,ah as wt,bh as jt,fh as Gt,gh as B,hh as E,j as nt,jg as A,kg as x,kh as P,lg as Mt,lh as k,mg as q,sg as X,v as Ut,va as at,w as I,ya as xt}from"./chunk-PQ6EZO2H.js";import{a as st,e as ue,g as w,h as Rt,i as g}from"./chunk-GHMOB5KC.js";var le=ue((Ft,re)=>{g();(function(c,t){typeof Ft=="object"&&typeof re<"u"?t(_()):typeof define=="function"&&define.amd?define(["leaflet"],t):t(c.L)})(Ft,function(c){"use strict";c=c&&c.hasOwnProperty("default")?c.default:c;function t(p,h){var d=h.x-p.x,m=h.y-p.y;return Math.sqrt(d*d+m*m)}var e=function(h,d){return(Math.atan2(d.y-h.y,d.x-h.x)*180/Math.PI+90+360)%360},i=function(h,d){var m=h.value,f=h.isInPixels;return f?m/d:m};function o(p){if(typeof p=="string"&&p.indexOf("%")!==-1)return{value:parseFloat(p)/100,isInPixels:!1};var h=p?parseFloat(p):0;return{value:h,isInPixels:h>0}}var n=function(h,d){return h.x===d.x&&h.y===d.y};function r(p){return p.reduce(function(h,d,m,f){if(m>0&&!n(d,f[m-1])){var y=f[m-1],C=h.length>0?h[h.length-1].distB:0,N=t(y,d);h.push({a:y,b:d,distA:C,distB:C+N,heading:e(y,d)})}return h},[])}function u(p,h){var d=r(p),m=d.length;if(m===0)return[];var f=d[m-1].distB,y=i(h.offset,f),C=i(h.endOffset,f),N=i(h.repeat,f),D=f*N,W=y>0?f*y:0,j=C>0?f*C:0,ot=[],Pt=W;do ot.push(Pt),Pt+=D;while(D>0&&Pt<f-j);var vt=0,z=d[0];return ot.map(function(zt){for(;zt>z.distB&&vt<m-1;)vt++,z=d[vt];var pe=(zt-z.distA)/(z.distB-z.distA);return{pt:s(z.a,z.b,pe),heading:z.heading}})}function s(p,h,d){return h.x!==p.x?{x:p.x+d*(h.x-p.x),y:p.y+d*(h.y-p.y)}:{x:p.x,y:p.y+(h.y-p.y)*d}}(function(){var p=L.Marker.prototype._initIcon,h=L.Marker.prototype._setPos,d=L.DomUtil.TRANSFORM==="msTransform";L.Marker.addInitHook(function(){var m=this.options.icon&&this.options.icon.options,f=m&&this.options.icon.options.iconAnchor;f&&(f=f[0]+"px "+f[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||f||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(y){y.target._applyRotation()})}),L.Marker.include({_initIcon:function(){p.call(this)},_setPos:function(m){h.call(this,m),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,d?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(m){return this.options.rotationAngle=m,this.update(),this},setRotationOrigin:function(m){return this.options.rotationOrigin=m,this.update(),this}})})(),c.Symbol=c.Symbol||{},c.Symbol.Dash=c.Class.extend({options:{pixelSize:10,pathOptions:{}},initialize:function(h){c.Util.setOptions(this,h),this.options.pathOptions.clickable=!1},buildSymbol:function(h,d,m,f,y){var C=this.options,N=Math.PI/180;if(C.pixelSize<=1)return c.polyline([h.latLng,h.latLng],C.pathOptions);var D=m.project(h.latLng),W=-(h.heading-90)*N,j=c.point(D.x+C.pixelSize*Math.cos(W+Math.PI)/2,D.y+C.pixelSize*Math.sin(W)/2),ot=D.add(D.subtract(j));return c.polyline([m.unproject(j),m.unproject(ot)],C.pathOptions)}}),c.Symbol.dash=function(p){return new c.Symbol.Dash(p)},c.Symbol.ArrowHead=c.Class.extend({options:{polygon:!0,pixelSize:10,headAngle:60,pathOptions:{stroke:!1,weight:2}},initialize:function(h){c.Util.setOptions(this,h),this.options.pathOptions.clickable=!1},buildSymbol:function(h,d,m,f,y){return this.options.polygon?c.polygon(this._buildArrowPath(h,m),this.options.pathOptions):c.polyline(this._buildArrowPath(h,m),this.options.pathOptions)},_buildArrowPath:function(h,d){var m=Math.PI/180,f=d.project(h.latLng),y=-(h.heading-90)*m,C=this.options.headAngle/2*m,N=y+C,D=y-C,W=c.point(f.x-this.options.pixelSize*Math.cos(N),f.y+this.options.pixelSize*Math.sin(N)),j=c.point(f.x-this.options.pixelSize*Math.cos(D),f.y+this.options.pixelSize*Math.sin(D));return[d.unproject(W),h.latLng,d.unproject(j)]}}),c.Symbol.arrowHead=function(p){return new c.Symbol.ArrowHead(p)},c.Symbol.Marker=c.Class.extend({options:{markerOptions:{},rotate:!1},initialize:function(h){c.Util.setOptions(this,h),this.options.markerOptions.clickable=!1,this.options.markerOptions.draggable=!1},buildSymbol:function(h,d,m,f,y){return this.options.rotate&&(this.options.markerOptions.rotationAngle=h.heading+(this.options.angleCorrection||0)),c.marker(h.latLng,this.options.markerOptions)}}),c.Symbol.marker=function(p){return new c.Symbol.Marker(p)};var a=function(h){return h instanceof c.LatLng||Array.isArray(h)&&h.length===2&&typeof h[0]=="number"},l=function(h){return Array.isArray(h)&&a(h[0])};c.PolylineDecorator=c.FeatureGroup.extend({options:{patterns:[]},initialize:function(h,d){c.FeatureGroup.prototype.initialize.call(this),c.Util.setOptions(this,d),this._map=null,this._paths=this._initPaths(h),this._bounds=this._initBounds(),this._patterns=this._initPatterns(this.options.patterns)},_initPaths:function(h,d){var m=this;if(l(h)){var f=d?h.concat([h[0]]):h;return[f]}return h instanceof c.Polyline?this._initPaths(h.getLatLngs(),h instanceof c.Polygon):Array.isArray(h)?h.reduce(function(y,C){return y.concat(m._initPaths(C,d))},[]):[]},_initPatterns:function(h){return h.map(this._parsePatternDef)},setPatterns:function(h){this.options.patterns=h,this._patterns=this._initPatterns(this.options.patterns),this.redraw()},setPaths:function(h){this._paths=this._initPaths(h),this._bounds=this._initBounds(),this.redraw()},_parsePatternDef:function(h,d){return{symbolFactory:h.symbol,offset:o(h.offset),endOffset:o(h.endOffset),repeat:o(h.repeat)}},onAdd:function(h){this._map=h,this._draw(),this._map.on("moveend",this.redraw,this)},onRemove:function(h){this._map.off("moveend",this.redraw,this),this._map=null,c.FeatureGroup.prototype.onRemove.call(this,h)},_initBounds:function(){var h=this._paths.reduce(function(d,m){return d.concat(m)},[]);return c.latLngBounds(h)},getBounds:function(){return this._bounds},_buildSymbols:function(h,d,m){var f=this;return m.map(function(y,C){return d.buildSymbol(y,h,f._map,C,m.length)})},_getDirectionPoints:function(h,d){var m=this;if(h.length<2)return[];var f=h.map(function(y){return m._map.project(y)});return u(f,d).map(function(y){return{latLng:m._map.unproject(c.point(y.pt)),heading:y.heading}})},redraw:function(){this._map&&(this.clearLayers(),this._draw())},_getPatternLayers:function(h){var d=this,m=this._map.getBounds().pad(.1);return this._paths.map(function(f){var y=d._getDirectionPoints(f,h).filter(function(C){return m.contains(C.latLng)});return c.featureGroup(d._buildSymbols(f,h.symbolFactory,y))})},_draw:function(){var h=this;this._patterns.map(function(d){return h._getPatternLayers(d)}).forEach(function(d){h.addLayer(c.featureGroup(d))})}}),c.polylineDecorator=function(p,h){return new c.PolylineDecorator(p,h)}})});g();g();g();var mt=w(_());g();var b=w(_());g();var ht=w(_());g();var _t=w(_());function O(c,t,e,i=!1,o=Tt.click,n){let r=_t.default.popup();return r.setContent(n),c.bindPopup(r,{autoClose:i,closeOnClick:!1}),o===Tt.hover&&(c.off("click"),c.on("mouseover",()=>{c.openPopup()}),c.on("mousemove",u=>{r.setLatLng(u.latlng)}),c.on("mouseout",()=>{c.closePopup()})),c.on("popupopen",()=>{St(r,t,e),c._popup._closeButton.addEventListener("click",u=>{u.preventDefault()})}),r}function St(c,t,e){let i=c.getElement().getElementsByClassName("tb-custom-action");Array.from(i).forEach(o=>{let n=o.getAttribute("data-action-name");o&&t.tooltipAction[n]&&(o.onclick=r=>(t.tooltipAction[n](r,e),!1))})}function et(c){return!!(c.length>1&&Array.isArray(c[0])&&(Array.isArray(c[0][0])||c[0][0]instanceof _t.default.LatLng))}function Dt(c){try{let t=JSON.parse(c);return!Array.isArray(t)}catch{return!1}}function ne(c,t){let e=document.createElement("div");for(let i of c)if(t?.showLabel){let o=t.useLabelFunction?k(t.parsedLabelFunction,[i,c,i.dsIndex]):t.label,n=T.prepareProcessPattern(o,!0),r=B(o,i);e.innerHTML=E(n,r,i),i.entityParseName=e.textContent||e.innerText||""}else i.entityParseName=i.entityName;return c}var de=c=>x(c)&&!X(c)&&!isNaN(c)&&isFinite(c)&&Math.abs(c)<=90,me=c=>x(c)&&!X(c)&&!isNaN(c)&&isFinite(c)&&Math.abs(c)<=180,ae=(c,t)=>de(c)&&me(t);var ct=class{constructor(t,e,i,o,n,r,u=!1){this.map=t,this.location=e,this.settings=i,this.data=o,this.dataSources=n,this.onDragendListener=r,this.editing=!1,this.createMarkerIconSubject=new nt,this.leafletMarker=ht.default.marker(this.location,{pmIgnore:!i.draggableMarker,snapIgnore:!u,tbMarkerData:this.data}),this.markerOffset=[A(i.markerOffsetX)?i.markerOffsetX:.5,A(i.markerOffsetY)?i.markerOffsetY:1],this.tooltipOffset=[A(i.tooltipOffsetX)?i.tooltipOffsetX:0,A(i.tooltipOffsetY)?i.tooltipOffsetY:-1],this.updateMarkerIcon(this.settings),i.showTooltip&&(this.tooltip=O(this.leafletMarker,i,o.$datasource,i.autocloseTooltip,i.showTooltipAction),this.updateMarkerTooltip(o)),this.settings.markerClick&&this.leafletMarker.on("click",s=>{for(let a in this.settings.markerClick)typeof this.settings.markerClick[a]=="function"&&this.settings.markerClick[a](s.originalEvent,this.data.$datasource)}),i.draggableMarker&&r&&(this.leafletMarker.on("pm:dragstart",()=>{this.leafletMarker.dragging._draggable={_moved:!0},this.leafletMarker.dragging._enabled=!0,this.editing=!0}),this.leafletMarker.on("pm:dragend",s=>{r(s,this.data),delete this.leafletMarker.dragging._draggable,delete this.leafletMarker.dragging._enabled,this.editing=!1}))}setDataSources(t,e){this.data=t,this.dataSources=e,this.leafletMarker.options.tbMarkerData=t}updateMarkerTooltip(t){if(!this.map.markerTooltipText||this.settings.useTooltipFunction){let e=this.settings.useTooltipFunction?k(this.settings.parsedTooltipFunction,[this.data,this.dataSources,this.data.dsIndex]):this.settings.tooltipPattern;this.map.markerTooltipText=T.prepareProcessPattern(e,!0),this.map.replaceInfoTooltipMarker=B(this.map.markerTooltipText,t)}this.tooltip.setContent(E(this.map.markerTooltipText,this.map.replaceInfoTooltipMarker,t)),this.tooltip.isOpen()&&this.tooltip.getElement()&&St(this.tooltip,this.settings,t.$datasource)}updateMarkerPosition(t){!this.leafletMarker.getLatLng().equals(t)&&!this.editing&&(this.location=t,this.leafletMarker.setLatLng(t))}updateMarkerLabel(t){if(this.leafletMarker.unbindTooltip(),t.showLabel){if(!this.map.markerLabelText||t.useLabelFunction){let o=t.useLabelFunction?k(t.parsedLabelFunction,[this.data,this.dataSources,this.data.dsIndex]):t.label;this.map.markerLabelText=T.prepareProcessPattern(o,!0),this.map.replaceInfoLabelMarker=B(this.map.markerLabelText,this.data)}let e=E(this.map.markerLabelText,this.map.replaceInfoLabelMarker,this.data),i=this.map.ctx.widgetConfig.color;this.leafletMarker.bindTooltip(`<div style="color: ${i};"><b>${e}</b></div>`,{className:"tb-marker-label",permanent:!0,direction:"top",offset:this.labelOffset})}}updateMarkerColor(t){this.createDefaultMarkerIcon(t,e=>{this.leafletMarker.setIcon(e.icon)})}updateMarkerIcon(t){this.createMarkerIcon(e=>{this.leafletMarker.setIcon(e.icon);let i=e.icon.options.iconAnchor;i&&Array.isArray(i)?this.labelOffset=[e.size[0]/2-i[0],10-i[1]]:this.labelOffset=[0,-e.size[1]*this.markerOffset[1]+10],this.updateMarkerLabel(t),this.createMarkerIconSubject.next(e)})}createMarkerIcon(t){if(this.settings.icon){t(this.settings.icon);return}else if(this.settings.icon$){this.settings.icon$.subscribe(o=>{t(o)});return}let e=this.settings.useMarkerImageFunction?k(this.settings.parsedMarkerImageFunction,[this.data,this.settings.markerImages,this.dataSources,this.data.dsIndex]):this.settings.currentImage,i=this.settings.tinyColor;if(this.settings.useColorFunction){let o=k(this.settings.parsedColorFunction,[this.data,this.dataSources,this.data.dsIndex]);x(o)&&(i=Z(o))}e&&e.url?Q(this.map.ctx.$injector.get(V),e.url).subscribe(o=>{if(o?.aspect){let n,r;o.aspect>1?(n=e.size,r=e.size/o.aspect):(n=e.size*o.aspect,r=e.size);let u=e.markerOffset,s=e.tooltipOffset;u||(u=[n*this.markerOffset[0],r*this.markerOffset[1]]),s||(s=[n*this.tooltipOffset[0],r*this.tooltipOffset[1]]);let a=ht.default.icon({iconUrl:o.url,iconSize:[n,r],iconAnchor:u,popupAnchor:s});t({size:[n,r],icon:a})}else this.createDefaultMarkerIcon(i,t)}):this.createDefaultMarkerIcon(i,t)}createDefaultMarkerIcon(t,e){let i;Z.equals(t,this.settings.tinyColor)?(this.map.defaultMarkerIconInfo||(this.map.defaultMarkerIconInfo=this.createColoredMarkerIcon(t)),i=this.map.defaultMarkerIconInfo):i=this.createColoredMarkerIcon(t),e(i)}createColoredMarkerIcon(t){return{size:[21,34],icon:ht.default.icon({iconUrl:this.createColorIconURI(t),iconSize:[21,34],iconAnchor:[21*this.markerOffset[0],34*this.markerOffset[1]],popupAnchor:[0,-34],shadowUrl:"assets/shadow.png",shadowSize:[40,37],shadowAnchor:[12,35]})}}createColorIconURI(t){let e=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="-191.35 -351.18 1083.58 1730.46"><path fill-rule="evenodd" clip-rule="evenodd" fill="#${t.toHex()}" stroke="#000" stroke-width="37" stroke-miterlimit="10" d="M351.833 1360.78c-38.766-190.3-107.116-348.665-189.903-495.44C100.523 756.469 29.386 655.978-36.434 550.404c-21.972-35.244-40.934-72.477-62.047-109.054-42.216-73.137-76.444-157.935-74.269-267.932 2.125-107.473 33.208-193.685 78.03-264.173C-21-206.69 102.481-301.745 268.164-326.724c135.466-20.425 262.475 14.082 352.543 66.747 73.6 43.038 130.596 100.528 173.92 168.28 45.22 70.716 76.36 154.26 78.971 263.233 1.337 55.83-7.805 107.532-20.684 150.417-13.034 43.41-33.996 79.695-52.646 118.455-36.406 75.659-82.049 144.981-127.855 214.345-136.437 206.606-264.496 417.31-320.58 706.028z"/><circle fill-rule="evenodd" clip-rule="evenodd" cx="352.891" cy="225.779" r="183.332"/></svg>`;return"data:image/svg+xml;base64,"+btoa(e)}removeMarker(){}extendBoundsWithMarker(t){t.extend(this.leafletMarker.getLatLng())}getMarkerPosition(){return this.leafletMarker.getLatLng()}setMarkerPosition(t){this.leafletMarker.setLatLng(t)}};g();var Se=w(le()),G=w(_());var pt=class{constructor(t,e,i,o,n){this.map=t,this.data=i,this.dataSources=o,this.leafletPoly=G.default.polyline(e,this.getPolyStyle(n)).addTo(this.map),n.usePolylineDecorator&&(this.polylineDecorator=new G.PolylineDecorator(this.leafletPoly,this.getDecoratorSettings(n)).addTo(this.map))}getDecoratorSettings(t){return{patterns:[{offset:t.decoratorOffset,endOffset:t.endDecoratorOffset,repeat:t.decoratorRepeat,symbol:G.Symbol[t.decoratorSymbol]({pixelSize:t.decoratorSymbolSize,polygon:!1,pathOptions:{color:t.useDecoratorCustomColor?t.decoratorCustomColor:this.getPolyStyle(t).color,stroke:!0}})}]}}updatePolyline(t,e,i,o){this.data=e,this.dataSources=i,this.leafletPoly.setLatLngs(t),this.leafletPoly.setStyle(this.getPolyStyle(o)),this.polylineDecorator&&this.polylineDecorator.setPaths(this.leafletPoly)}getPolyStyle(t){return{interactive:!1,color:F(t.useColorFunction,t.parsedColorFunction,[this.data,this.dataSources,this.data.dsIndex],t.color),opacity:F(t.useStrokeOpacityFunction,t.parsedStrokeOpacityFunction,[this.data,this.dataSources,this.data.dsIndex],t.strokeOpacity),weight:F(t.useStrokeWeightFunction,t.parsedStrokeWeightFunction,[this.data,this.dataSources,this.data.dsIndex],t.strokeWeight),pmIgnore:!0}}removePolyline(){this.map.removeLayer(this.leafletPoly)}getPolylineLatLngs(){return this.leafletPoly.getLatLngs()}};g();var H=w(_());var ut=class{constructor(t,e,i,o,n,r=!1){this.map=t,this.data=e,this.dataSources=i,this.settings=o,this.onDragendListener=n,this.editing=!1;let u=this.getPolygonColor(o),s=this.getPolygonStrokeColor(o),a=e[this.settings.polygonKeyName],l=et(a)||a.length!==2?H.default.polygon:H.default.rectangle;this.leafletPoly=l(a,{fill:!0,fillColor:u,color:s,weight:o.polygonStrokeWeight,fillOpacity:o.polygonOpacity,opacity:o.polygonStrokeOpacity,pmIgnore:!o.editablePolygon,snapIgnore:!r}).addTo(this.map.map),o.showPolygonLabel&&this.updateLabel(o),o.showPolygonTooltip&&(this.tooltip=O(this.leafletPoly,o,e.$datasource,o.autoClosePolygonTooltip,o.showPolygonTooltipAction),this.updateTooltip(e)),this.createEventListeners()}createEventListeners(){this.settings.editablePolygon&&this.onDragendListener&&(this.leafletPoly.on("pm:dragstart",()=>this.editing=!0),this.leafletPoly.on("pm:dragend",()=>this.editing=!1),this.leafletPoly.on("pm:rotatestart",()=>this.editing=!0),this.leafletPoly.on("pm:rotateend",()=>this.editing=!1),this.leafletPoly.on("pm:markerdragstart",()=>this.editing=!0),this.leafletPoly.on("pm:markerdragend",()=>this.editing=!1),this.leafletPoly.on("pm:edit",t=>this.onDragendListener(t,this.data))),this.settings.polygonClick&&this.leafletPoly.on("click",t=>{for(let e in this.settings.polygonClick)typeof this.settings.polygonClick[e]=="function"&&this.settings.polygonClick[e](t.originalEvent,this.data.$datasource)})}updateTooltip(t){let e=this.settings.usePolygonTooltipFunction?k(this.settings.parsedPolygonTooltipFunction,[this.data,this.dataSources,this.data.dsIndex]):this.settings.polygonTooltipPattern;this.tooltip.setContent(T.parseTemplate(e,t,!0))}updateLabel(t){if(this.leafletPoly.unbindTooltip(),t.showPolygonLabel){if(!this.map.polygonLabelText||t.usePolygonLabelFunction){let o=t.usePolygonLabelFunction?k(t.parsedPolygonLabelFunction,[this.data,this.dataSources,this.data.dsIndex]):t.polygonLabel;this.map.polygonLabelText=T.prepareProcessPattern(o,!0),this.map.replaceInfoLabelPolygon=B(this.map.polygonLabelText,this.data)}let e=E(this.map.polygonLabelText,this.map.replaceInfoLabelPolygon,this.data),i=this.map.ctx.widgetConfig.color;this.leafletPoly.bindTooltip(`<div style="color: ${i};"><b>${e}</b></div>`,{className:"tb-polygon-label",permanent:!0,direction:"center"}).openTooltip(this.leafletPoly.getBounds().getCenter())}}updatePolygon(t,e,i){if(this.editing)return;this.data=t,this.dataSources=e;let o=t[this.settings.polygonKeyName];if(et(o)||o.length!==2)if(this.leafletPoly instanceof H.default.Rectangle){this.map.map.removeLayer(this.leafletPoly);let n=this.getPolygonColor(i),r=this.getPolygonStrokeColor(i);this.leafletPoly=H.default.polygon(o,{fill:!0,fillColor:n,color:r,weight:i.polygonStrokeWeight,fillOpacity:i.polygonOpacity,opacity:i.polygonStrokeOpacity,pmIgnore:!i.editablePolygon}).addTo(this.map.map),i.showPolygonTooltip&&(this.tooltip=O(this.leafletPoly,i,t.$datasource,i.autoClosePolygonTooltip,i.showPolygonTooltipAction)),this.createEventListeners()}else this.leafletPoly.setLatLngs(o);else if(o.length===2){let n=new H.default.LatLngBounds(o);this.leafletPoly.setBounds(n)}i.showPolygonTooltip&&this.updateTooltip(this.data),i.showPolygonLabel&&this.updateLabel(i),this.updatePolygonColor(i)}removePolygon(){this.map.map.removeLayer(this.leafletPoly)}updatePolygonColor(t){let e=this.getPolygonColor(t),i=this.getPolygonStrokeColor(t),o={fillColor:e,color:i};this.leafletPoly.setStyle(o)}getPolygonLatLngs(){return this.leafletPoly.getLatLngs()}setPolygonLatLngs(t){this.leafletPoly.setLatLngs(t),this.leafletPoly.redraw()}getPolygonColor(t){return F(t.usePolygonColorFunction,t.parsedPolygonColorFunction,[this.data,this.dataSources,this.data.dsIndex],t.polygonColor)}getPolygonStrokeColor(t){return F(t.usePolygonStrokeColorFunction,t.parsedPolygonStrokeColorFunction,[this.data,this.dataSources,this.data.dsIndex],t.polygonStrokeColor)}};g();var It=w(_());var dt=class{constructor(t,e,i,o,n,r=!1){this.map=t,this.data=e,this.dataSources=i,this.settings=o,this.onDragendListener=n,this.editing=!1,this.circleData=this.map.convertToCircleFormat(JSON.parse(e[this.settings.circleKeyName]));let u=this.createCenterPosition(),s=this.getFillColor(),a=this.getStrokeColor();this.leafletCircle=It.default.circle(u,{radius:this.circleData.radius,fillColor:s,color:a,weight:o.circleStrokeWeight,fillOpacity:o.circleFillColorOpacity,opacity:o.circleStrokeOpacity,pmIgnore:!o.editableCircle,snapIgnore:!r}).addTo(this.map.map),o.showCircleLabel&&this.updateLabel(),o.showCircleTooltip&&(this.tooltip=O(this.leafletCircle,o,e.$datasource,o.autoCloseCircleTooltip,o.showCircleTooltipAction),this.updateTooltip()),this.createEventListeners()}createEventListeners(){this.settings.editableCircle&&this.onDragendListener&&(this.leafletCircle.on("pm:dragstart",()=>this.editing=!0),this.leafletCircle.on("pm:dragend",()=>this.editing=!1),this.leafletCircle.on("pm:markerdragstart",()=>this.editing=!0),this.leafletCircle.on("pm:markerdragend",()=>this.editing=!1),this.leafletCircle.on("pm:edit",t=>this.onDragendListener(t,this.data))),this.settings.circleClick&&this.leafletCircle.on("click",t=>{for(let e in this.settings.circleClick)typeof this.settings.circleClick[e]=="function"&&this.settings.circleClick[e](t.originalEvent,this.data.$datasource)})}updateLabel(){if(this.leafletCircle.unbindTooltip(),this.settings.showCircleLabel){if(!this.map.circleLabelText||this.settings.useCircleLabelFunction){let i=this.settings.useCircleLabelFunction?k(this.settings.parsedCircleLabelFunction,[this.data,this.dataSources,this.data.dsIndex]):this.settings.circleLabel;this.map.circleLabelText=T.prepareProcessPattern(i,!0),this.map.replaceInfoTooltipCircle=B(this.map.circleLabelText,this.data)}let t=E(this.map.circleLabelText,this.map.replaceInfoTooltipCircle,this.data),e=this.map.ctx.widgetConfig.color;this.leafletCircle.bindTooltip(`<div style="color: ${e};"><b>${t}</b></div>`,{className:"tb-polygon-label",permanent:!0,direction:"center"}).openTooltip(this.leafletCircle.getLatLng())}}updateTooltip(){let t=this.settings.useCircleTooltipFunction?k(this.settings.parsedCircleTooltipFunction,[this.data,this.dataSources,this.data.dsIndex]):this.settings.circleTooltipPattern;this.tooltip.setContent(T.parseTemplate(t,this.data,!0))}updateCircleColor(){let t=this.getFillColor(),e=this.getStrokeColor(),i={fillColor:t,color:e};this.leafletCircle.setStyle(i)}updateCircle(t,e){if(this.editing)return;this.data=t,this.dataSources=e,this.circleData=this.map.convertToCircleFormat(JSON.parse(t[this.settings.circleKeyName]));let i=this.createCenterPosition();!this.leafletCircle.getLatLng().equals(i)&&!this.editing&&this.leafletCircle.setLatLng(i),this.leafletCircle.getRadius()!==this.circleData.radius&&this.leafletCircle.setRadius(this.circleData.radius),this.settings.showCircleLabel&&this.updateLabel(),this.settings.showCircleTooltip&&this.updateTooltip(),(this.settings.useCircleStrokeColorFunction||this.settings.useCircleFillColorFunction)&&this.updateCircleColor()}createCenterPosition(){return new It.default.LatLng(this.circleData.latitude,this.circleData.longitude)}getFillColor(){return F(this.settings.useCircleFillColorFunction,this.settings.parsedCircleFillColorFunction,[this.data,this.dataSources,this.data.dsIndex],this.settings.circleFillColor)}getStrokeColor(){return F(this.settings.useCircleStrokeColorFunction,this.settings.parsedCircleStrokeColorFunction,[this.data,this.dataSources,this.data.dsIndex],this.settings.circleStrokeColor)}};var S=class{constructor(t,e,i){this.ctx=t,this.$container=e,this.markers=new Map,this.polylines=new Map,this.polygons=new Map,this.circles=new Map,this.markersData=[],this.polygonsData=[],this.circleData=[],this.loading=!1,this.replaceInfoLabelMarker=[],this.replaceInfoLabelPolygon=[],this.replaceInfoTooltipMarker=[],this.replaceInfoTooltipCircle=[],this.updatePending=!1,this.editPolygons=!1,this.editCircle=!1,this.ignoreUpdateBounds=!1,this.initDragModeIgnoreUpdateBoundsSet=!1,this.southWest=new b.default.LatLng(-b.Projection.SphericalMercator.MAX_LATITUDE,-180),this.northEast=new b.default.LatLng(b.Projection.SphericalMercator.MAX_LATITUDE,180),this.tooltipInstances=[],this.dragMarker=(o,n={})=>{o!==void 0&&this.saveLocation(n,this.convertToCustomFormat(o.target._latlng)).subscribe()},this.dragPolygonVertex=(o,n={})=>{if(o===void 0)return;let r=o.layer.getLatLngs();if(r.length===1&&(r=r[0]),o.shape==="Rectangle"&&!et(r)){let u=o.layer.getBounds(),s=[u.getNorthWest(),u.getNorthEast(),u.getSouthWest(),u.getSouthEast()];r.every(a=>s.find(l=>l.equals(a))!==void 0)&&(r=[u.getNorthWest(),u.getSouthEast()])}this.saveLocation(n,this.convertPolygonToCustomFormat(r)).subscribe(()=>{})},this.dragCircleVertex=(o,n={})=>{if(o===void 0)return;let r=o.layer.getLatLng(),u=o.layer.getRadius();this.saveLocation(n,this.convertCircleToCustomFormat(r,u)).subscribe(()=>{})},this.options=i,this.options.tinyColor=Z(this.options.color||lt.color),this.editPolygons=i.showPolygon&&i.editablePolygon,this.editCircle=i.showCircle&&i.editableCircle,b.default.Icon.Default.imagePath="/",this.translateService=this.ctx.$injector.get(rt),this.initMarkerClusterSettings()}initMarkerClusterSettings(){let t=this.options;t.useClusterMarkers&&(this.clusteringSettings={spiderfyOnMaxZoom:t.spiderfyOnMaxZoom,zoomToBoundsOnClick:t.zoomOnClick,showCoverageOnHover:t.showCoverageOnHover,removeOutsideVisibleBounds:t.removeOutsideVisibleBounds,animate:t.animate,chunkedLoading:t.chunkedLoading,pmIgnore:!0,spiderLegPolylineOptions:{pmIgnore:!0},polygonOptions:{pmIgnore:!0}},t.useIconCreateFunction&&t.clusterMarkerFunction&&(this.clusteringSettings.iconCreateFunction=e=>{let i=e.getChildCount(),o=e.getAllChildMarkers().map(r=>r.options.tbMarkerData),n=t.clusterMarkerFunction?k(t.parsedClusterMarkerFunction,[o,i]):null;if(x(n)&&Z(n).isValid()){let r=Z(n);return b.default.divIcon({html:`<div style="background-color: ${r.setAlpha(.4).toRgbString()};" class="marker-cluster tb-cluster-marker-element"><div style="background-color: ${r.setAlpha(.9).toRgbString()};"><span>`+i+"</span></div></div>",iconSize:new b.default.Point(40,40),className:"tb-cluster-marker-container"})}else{let r=" marker-cluster-";return i<10?r+="small":i<100?r+="medium":r+="large",new b.default.DivIcon({html:"<div><span>"+i+"</span></div>",className:"marker-cluster"+r,iconSize:new b.default.Point(40,40)})}}),t.maxClusterRadius&&t.maxClusterRadius>0&&(this.clusteringSettings.maxClusterRadius=Math.floor(t.maxClusterRadius)),t.maxZoom&&t.maxZoom>=0&&t.maxZoom<19&&(this.clusteringSettings.disableClusteringAtZoom=Math.floor(t.maxZoom)),this.markersCluster=new b.default.MarkerClusterGroup(this.clusteringSettings))}selectEntityWithoutLocationDialog(t){let e,i;switch(t){case"Polygon":case"Rectangle":e=this.datasources.filter(n=>!this.isValidPolygonPosition(n)),i={showLabel:this.options.showPolygonLabel,useLabelFunction:this.options.usePolygonLabelFunction,parsedLabelFunction:this.options.parsedPolygonLabelFunction,label:this.options.polygonLabel};break;case"Marker":e=this.datasources.filter(n=>!this.extractPosition(n)),i={showLabel:this.options.showLabel,useLabelFunction:this.options.useLabelFunction,parsedLabelFunction:this.options.parsedLabelFunction,label:this.options.label};break;case"Circle":e=this.datasources.filter(n=>!this.isValidCircle(n)),i={showLabel:this.options.showCircleLabel,useLabelFunction:this.options.useCircleLabelFunction,parsedLabelFunction:this.options.parsedCircleLabelFunction,label:this.options.circleLabel};break;default:return I(null)}return e=ne(e,i),e.length===1?I(e[0]):this.ctx.$injector.get(Yt).open(se,{disableClose:!0,panelClass:["tb-dialog","tb-fullscreen-dialog"],data:{entities:e}}).afterClosed()}selectEntityWithoutLocation(t){this.selectEntityWithoutLocationDialog(t.substring(2)).subscribe(e=>{if(e!==null){this.selectedEntity=e,this.toggleDrawMode(t);let i,o;switch(t){case"tbMarker":i=this.translateService.instant("widgets.maps.tooltips.placeMarker",{entityName:e.entityParseName}),this.map.pm.Draw.tbMarker._hintMarker.setTooltipContent(i);break;case"tbCircle":i=this.translateService.instant("widgets.maps.tooltips.startCircle",{entityName:e.entityParseName}),this.map.pm.Draw.tbCircle._hintMarker.setTooltipContent(i),o={tooltips:{finishCircle:this.translateService.instant("widgets.maps.tooltips.finishCircle",{entityName:e.entityParseName})}};break;case"tbRectangle":i=this.translateService.instant("widgets.maps.tooltips.firstVertex",{entityName:e.entityParseName}),this.map.pm.Draw.tbRectangle._hintMarker.setTooltipContent(i),o={tooltips:{finishRect:this.translateService.instant("widgets.maps.tooltips.finishRect",{entityName:e.entityParseName})}};break;case"tbPolygon":i=this.translateService.instant("widgets.maps.tooltips.firstVertex",{entityName:e.entityParseName}),this.map.pm.Draw.tbPolygon._hintMarker.setTooltipContent(i),o={tooltips:{continueLine:this.translateService.instant("widgets.maps.tooltips.continueLine",{entityName:e.entityParseName}),finishPoly:this.translateService.instant("widgets.maps.tooltips.finishPoly",{entityName:e.entityParseName})}};break}o&&(this.map.pm.setLang("en",o,"en"),this.createdControlButtonTooltip())}else this.map.pm.Toolbar.toggleButton(t,!1)})}toggleDrawMode(t){this.map.pm.Draw[t].toggle()}addEditControl(){if(this.options.draggableMarker&&!this.options.hideDrawControlButton){let t=[{text:b.default.PM.Utils.getTranslation("actions.cancel"),onClick:()=>this.toggleDrawMode("tbMarker")}];this.map.pm.Toolbar.copyDrawControl("Marker",{name:"tbMarker",afterClick:()=>this.selectEntityWithoutLocation("tbMarker"),disabled:!1,actions:t})}if(this.editPolygons&&!this.options.hideDrawControlButton){let t=[{text:b.default.PM.Utils.getTranslation("actions.cancel"),onClick:()=>this.toggleDrawMode("tbRectangle")}],e=["finish","removeLastVertex",{text:b.default.PM.Utils.getTranslation("actions.cancel"),onClick:()=>this.toggleDrawMode("tbPolygon")}];this.map.pm.Toolbar.copyDrawControl("Rectangle",{name:"tbRectangle",afterClick:()=>this.selectEntityWithoutLocation("tbRectangle"),disabled:!1,actions:t}),this.map.pm.Toolbar.copyDrawControl("Polygon",{name:"tbPolygon",afterClick:()=>this.selectEntityWithoutLocation("tbPolygon"),disabled:!1,actions:e})}if(this.editCircle&&!this.options.hideDrawControlButton){let t=[{text:b.default.PM.Utils.getTranslation("actions.cancel"),onClick:()=>this.toggleDrawMode("tbCircle")}];this.map.pm.Toolbar.copyDrawControl("Circle",{name:"tbCircle",afterClick:()=>this.selectEntityWithoutLocation("tbCircle"),disabled:!1,actions:t})}this.editPolygons&&!this.options.hideEditControlButton&&(this.map.pm.Toolbar.copyDrawControl("cutPolygon",{name:"tbCut",title:this.translateService.instant("widgets.maps.buttonTitles.cutButton"),block:"edit",onClick:()=>{this.map.pm.setLang("en",{tooltips:{firstVertex:this.translateService.instant("widgets.maps.tooltips.firstVertex-cut"),continueLine:this.translateService.instant("widgets.maps.tooltips.continueLine-cut"),finishPoly:this.translateService.instant("widgets.maps.tooltips.finishPoly-cut")}},"en"),this.createdControlButtonTooltip()},afterClick:(t,e)=>{this.map.pm.Draw[e.button._button.jsClass].toggle({snappable:this.options.snappable,cursorMarker:!0,allowSelfIntersection:!1})}}),this.map.pm.Toolbar.changeControlOrder(["tbMarker","tbRectangle","tbPolygon","tbCircle","editMode","dragMode","tbCut","removalMode","rotateMode"])),this.map.pm.setLang("en",this.translateService.instant("widgets.maps"),"en"),this.options.hideAllControlButton||this.map.pm.addControls({position:"topleft",drawControls:!this.options.hideDrawControlButton,drawMarker:!1,drawCircle:!1,drawCircleMarker:!1,drawRectangle:!1,drawPolyline:!1,drawPolygon:!1,drawText:!1,dragMode:!this.options.hideEditControlButton,editMode:(this.editPolygons||this.editCircle)&&!this.options.hideEditControlButton,cutPolygon:!1,removalMode:!this.options.hideRemoveControlButton,rotateMode:this.editPolygons&&!this.options.hideEditControlButton}),this.options.initDragMode&&this.map.pm.enableGlobalDragMode(),this.map.on("pm:globaldrawmodetoggled",t=>this.ignoreUpdateBounds=t.enabled),this.map.on("pm:globaleditmodetoggled",t=>this.ignoreUpdateBounds=t.enabled),this.map.on("pm:globaldragmodetoggled",t=>this.ignoreUpdateBounds=t.enabled),this.map.on("pm:globalremovalmodetoggled",t=>this.ignoreUpdateBounds=t.enabled),this.map.on("pm:globalcutmodetoggled",t=>this.ignoreUpdateBounds=t.enabled),this.map.on("pm:globalrotatemodetoggled",t=>this.ignoreUpdateBounds=t.enabled),this.map.on("pm:create",t=>{switch(t.shape){case"tbMarker":this.saveLocation(this.selectedEntity,this.convertToCustomFormat(t.marker.getLatLng())).subscribe(()=>{});break;case"tbRectangle":case"tbPolygon":let e;if(t.shape==="tbRectangle"){let i=t.layer.getBounds();e=[i.getNorthWest(),i.getSouthEast()]}else e=t.layer.getLatLngs()[0];this.saveLocation(this.selectedEntity,this.convertPolygonToCustomFormat(e)).subscribe(()=>{});break;case"tbCircle":this.saveLocation(this.selectedEntity,this.convertCircleToCustomFormat(t.layer.getLatLng(),t.layer.getRadius())).subscribe(()=>{})}t.layer._pmTempLayer=!0,t.layer.remove()}),this.map.on("pm:cut",t=>{t.originalLayer.setLatLngs(t.layer.getLatLngs()),t.originalLayer.addTo(this.map),t.originalLayer._pmTempLayer=!1;let e=this.polygons.values(),i=e.next();for(;!i.done&&t.originalLayer!==i.value.leafletPoly;)i=e.next();t.layer._pmTempLayer=!0,t.layer.remove()}),this.map.on("pm:remove",t=>{if(t.shape==="Marker"){let e=this.markers.values(),i=e.next();for(;!i.done&&t.layer!==i.value.leafletMarker;)i=e.next();this.saveLocation(i.value.data,this.convertToCustomFormat(null)).subscribe(()=>{})}else if(t.shape==="Polygon"||t.shape==="Rectangle"){let e=this.polygons.values(),i=e.next();for(;!i.done&&t.layer!==i.value.leafletPoly;)i=e.next();this.saveLocation(i.value.data,this.convertPolygonToCustomFormat(null)).subscribe(()=>{})}else if(t.shape==="Circle"){let e=this.circles.values(),i=e.next();for(;!i.done&&t.layer!==i.value.leafletCircle;)i=e.next();this.saveLocation(i.value.data,this.convertCircleToCustomFormat(null,0)).subscribe(()=>{})}})}setLoading(t){this.loading!==t&&(this.loading=t,this.loading?(this.loadingDiv||(this.loadingDiv=oe(this.ctx.translate.instant("common.loading"))),this.$container.appendChild(this.loadingDiv[0])):this.loadingDiv&&this.loadingDiv.remove())}setMap(t){this.map=t,this.map.on("move",()=>{this.ctx.updatePopoverPositions()}),this.map.on("zoomstart",()=>{this.ctx.setPopoversHidden(!0)}),this.map.on("zoomend",()=>{this.ctx.setPopoversHidden(!1),this.ctx.updatePopoverPositions(),setTimeout(()=>{this.ctx.updatePopoverPositions()})}),this.options.useDefaultCenterPosition?(this.map.panTo(this.options.parsedDefaultCenterPosition),this.bounds=t.getBounds()):this.bounds=new b.default.LatLngBounds(null,null),this.options.disableScrollZooming&&this.map.scrollWheelZoom.disable(),this.options.draggableMarker||this.editPolygons||this.editCircle?(t.pm.setGlobalOptions({snappable:!1}),t.pm.applyGlobalOptions(),this.addEditControl()):this.map.pm.disableDraw(),this.options.useClusterMarkers&&this.map.addLayer(this.markersCluster),this.updatePending&&(this.updatePending=!1,this.updateData(this.drawRoutes)),this.createdControlButtonTooltip()}resetState(){this.options.initDragMode&&(this.initDragModeIgnoreUpdateBoundsSet=!1,this.ignoreUpdateBounds=!1)}createdControlButtonTooltip(){import("./chunk-OWQOMBUM.js").then(()=>{$.tooltipster&&(this.tooltipInstances.forEach(t=>{t.destroy()}),this.tooltipInstances=[]),$(this.ctx.$container).find('a[role="button"]:not(.leaflet-pm-action)').each((t,e)=>{let i;e.title?(i=e.title,$(e).removeAttr("title")):e.parentElement.title&&(i=e.parentElement.title,$(e).parent().removeAttr("title"));let o=$(e).tooltipster({content:i,theme:"tooltipster-shadow",delay:10,triggerClose:{click:!0,tap:!0,scroll:!0,mouseleave:!0},side:"right",distance:2,trackOrigin:!0,functionBefore:(n,r)=>{if(r.origin.ariaDisabled==="true"||r.origin.parentElement.classList.contains("active"))return!1}});this.tooltipInstances.push(o.tooltipster("instance"))})})}createLatLng(t,e){return b.default.latLng(t,e)}createBounds(){return this.map.getBounds()}extendBounds(t,e){e&&e.getLatLngs()&&e.getBounds()&&t.extend(e.getBounds())}invalidateSize(){this.map?.invalidateSize(!0)}onResize(){}getCenter(){return this.map.getCenter()}fitBounds(t,e){t.isValid()&&(this.bounds=this.bounds?this.bounds.extend(t):t,!this.options.fitMapBounds&&this.options.defaultZoomLevel?(this.map.setZoom(this.options.defaultZoomLevel,{animate:!1}),this.options.useDefaultCenterPosition?this.map.panTo(this.options.parsedDefaultCenterPosition,{animate:!1}):this.map.panTo(this.bounds.getCenter())):(this.map.once("zoomend",()=>{let i=this.options.minZoomLevel;this.options.defaultZoomLevel&&(i=Math.max(i,this.options.defaultZoomLevel)),this.map.getZoom()>i&&this.map.setZoom(i,{animate:!1})}),this.options.useDefaultCenterPosition&&(this.bounds=this.bounds.extend(this.options.parsedDefaultCenterPosition)),this.map.fitBounds(this.bounds,{padding:e||[50,50],animate:!1}),this.map.invalidateSize()))}extractPosition(t){if(!t)return null;let e=t[this.options.latKeyName],i=t[this.options.lngKeyName];return ae(e,i)?{x:e,y:i}:null}positionToLatLng(t){return b.default.latLng(t.x,t.y)}convertPosition(t,e){let i=this.extractPosition(t);return i?this.positionToLatLng(i):null}convertPositionPolygon(t){return t.map(e=>!Array.isArray(e[0])&&e.length===2?e:Array.isArray(e)&&e.length?this.convertPositionPolygon(e):null).filter(e=>!!e)}convertToCustomFormat(t,e=0){return t=t?tt(t,this.southWest,this.northEast,e):{lat:null,lng:null},{[this.options.latKeyName]:t.lat,[this.options.lngKeyName]:t.lng}}convertToPolygonFormat(t){return t.length?t.map(e=>{if(e.length)return this.convertToPolygonFormat(e);{let i=tt(e,this.southWest,this.northEast);return[i.lat,i.lng]}}):[]}convertPolygonToCustomFormat(t){let e=t?this.convertToPolygonFormat(t):null;return{[this.options.polygonKeyName]:e}}updateData(t){let e=this.ctx.data,i=wt(e);if(this.ctx.latestData&&this.ctx.latestData.length){let n=wt(this.ctx.latestData);i=Gt(i,n)}let o=null;t&&(o=jt(e)),this.updateFromData(t,i,o)}updateFromData(t,e,i,o){if(this.drawRoutes=t,this.map){if(t&&this.updatePolylines(i,e,!1),this.options.showPolygon&&this.updatePolygons(e,!1),this.options.showCircle&&this.updateCircle(e,!1),this.updateMarkers(e,!1,o),this.updateBoundsInternal(),this.options.draggableMarker||this.editPolygons||this.editCircle){let n=!1,r=!1,u=!1;if(this.options.draggableMarker&&!this.options.hideDrawControlButton&&!this.options.hideAllControlButton){let s=!1;for(let a of e){let l=this.extractPosition(a);if(l?l&&(n=!0):s=!0,s&&n)break}this.map.pm.Toolbar.getButtons().tbMarker.disable!==s&&this.map.pm.Toolbar.setButtonDisabled("tbMarker",!s),this.datasources=e}if(this.editPolygons&&!this.options.hideDrawControlButton&&!this.options.hideAllControlButton){let s=!1;for(let a of e){let l=this.isValidPolygonPosition(a);if(l?l&&(r=!0):s=!0,s&&r)break}this.map.pm.Toolbar.getButtons().tbPolygon.disable!==s&&(this.map.pm.Toolbar.setButtonDisabled("tbPolygon",!s),this.map.pm.Toolbar.setButtonDisabled("tbRectangle",!s)),this.datasources=e}if(this.editCircle&&!this.options.hideDrawControlButton&&!this.options.hideAllControlButton){let s=!1;for(let a of e){let l=this.isValidCircle(a);if(l?l&&(u=!0):s=!0,s&&u)break}this.map.pm.Toolbar.getButtons().tbCircle.disable!==s&&this.map.pm.Toolbar.setButtonDisabled("tbCircle",!s),this.datasources=e}if(!this.options.hideRemoveControlButton&&!this.options.hideAllControlButton){let s=!n&&!r&&!u;s&&this.map.pm.globalRemovalModeEnabled()&&this.map.pm.toggleGlobalRemovalMode(),this.map.pm.Toolbar.setButtonDisabled("removalMode",s)}if(!this.options.hideEditControlButton&&!this.options.hideAllControlButton){let s=!n&&!r&&!u;if(this.map.pm.Toolbar.getButtons().dragMode.disable!==s){this.map.pm.Toolbar.setButtonDisabled("dragMode",s);let a=r||u;(this.editPolygons||this.editCircle)&&this.map.pm.Toolbar.getButtons().editMode.disable!==a&&this.map.pm.Toolbar.setButtonDisabled("editMode",!a),this.editPolygons&&this.map.pm.Toolbar.getButtons().tbCut.disable!==r&&(this.map.pm.Toolbar.setButtonDisabled("tbCut",!r),this.map.pm.Toolbar.setButtonDisabled("rotateMode",!r))}}}}else this.updatePending=!0}updateBoundsInternal(){let t=new b.default.LatLngBounds(null,null);this.drawRoutes&&this.polylines.forEach(i=>{t.extend(i.leafletPoly.getBounds())}),this.options.showPolygon&&this.polygons.forEach(i=>{t.extend(i.leafletPoly.getBounds())}),this.options.showCircle&&this.circles.forEach(i=>{t.extend(i.leafletCircle.getBounds())}),this.options.useClusterMarkers&&this.markersCluster.getBounds().isValid()?t.extend(this.markersCluster.getBounds()):this.markers.forEach(i=>{t.extend(i.leafletMarker.getLatLng())});let e=this.map.getBounds();t.isValid()&&((!this.bounds||!this.bounds.isValid()||!this.bounds.equals(t)&&this.options.fitMapBounds)&&!e.contains(t))&&(this.bounds=t,this.ignoreUpdateBounds||this.fitBounds(t)),this.options.initDragMode&&!this.initDragModeIgnoreUpdateBoundsSet&&t.isValid()&&(this.initDragModeIgnoreUpdateBoundsSet=!0,this.ignoreUpdateBounds=!0)}updateMarkers(t,e=!0,i){let o=t.filter(l=>!!this.extractPosition(l)),n=new Set(Array.from(this.markers.keys())),r=[],u=[],s=[],a;o.forEach(l=>{if(l.rotationAngle||l.rotationAngle===0){let p=this.options.useMarkerImageFunction?k(this.options.parsedMarkerImageFunction,[l,this.options.markerImages,t,l.dsIndex]):this.options.currentImage,h=p?this.ctx.$injector.get(V).transform(p.url,{asString:!0,ignoreLoadingImage:!0}):I(null);this.options.icon$=h.pipe(Zt(d=>{let m=this.options.useMarkerImageFunction&&p?p.size:this.options.markerImageSize,f=`height: ${m||34}px; width: ${m||34}px;`,y=d?"background-image: url("+d+"); "+f:"";return{icon:b.default.divIcon({html:`<div class="arrow"
               style="transform: translate(-10px, -10px)
               rotate(${l.rotationAngle}deg);
               ${y}"><div>`}),size:[m,m]}})),this.options.icon=null}else this.options.icon=null,this.options.icon$=null;this.markers.get(l.entityName)?(a=this.updateMarker(l.entityName,l,t,this.options),a&&u.push(a)):(a=this.createMarker(l.entityName,l,t,this.options,e,i,this.options.snappable),a&&r.push(a)),n.delete(l.entityName)}),n.forEach(l=>{a=this.deleteMarker(l),a&&s.push(a)}),this.markersData=t,this.options.useClusterMarkers&&(r.length&&r.forEach(l=>{l.createMarkerIconSubject.pipe(xt(()=>this.markersCluster.addLayer(l.leafletMarker)),Lt(1)).subscribe()}),u.length&&this.markersCluster.refreshClusters(u.map(l=>l.leafletMarker)),s.length&&this.markersCluster.removeLayers(s.map(l=>l.leafletMarker)))}createMarker(t,e,i,o,n=!0,r,u=!1){let s=new ct(this,this.convertPosition(e,i),o,e,i,this.dragMarker,u);return r&&s.leafletMarker.on("click",()=>{r(e,!0)}),this.bounds&&n&&!this.options.useClusterMarkers&&this.fitBounds(this.bounds.extend(s.leafletMarker.getLatLng())),this.markers.set(t,s),this.options.useClusterMarkers||s.createMarkerIconSubject.pipe(xt(()=>{this.map.addLayer(s.leafletMarker),this.map.pm.globalDragModeEnabled()&&s.leafletMarker.pm&&s.leafletMarker.pm.enableLayerDrag()}),Lt(1)).subscribe(),s}updateMarker(t,e,i,o){let n=this.markers.get(t),r=this.convertPosition(e,i);return n.updateMarkerPosition(r),n.setDataSources(e,i),o.showTooltip&&n.updateMarkerTooltip(e),n.updateMarkerIcon(o),n}deleteMarker(t){let e=this.markers.get(t),i=e?.leafletMarker;return i&&(this.options.useClusterMarkers||this.map.removeLayer(i),this.markers.delete(t)),e}deletePolygon(t){let e=this.polygons.get(t)?.leafletPoly;return e&&(this.map.removeLayer(e),this.polygons.delete(t)),e}updatePoints(t,e){t.length&&(this.points&&this.map.removeLayer(this.points),this.points=new b.FeatureGroup);let i=this.options.pointColor;for(let o of t)for(let n=0;n<o.length;n++){let r=o[n];if(this.extractPosition(r)){let u=t.map(a=>a[n]);this.options.useColorPointFunction&&(i=k(this.options.parsedColorPointFunction,[r,u,r.dsIndex]));let s=b.default.circleMarker(this.convertPosition(r,u),{color:i,radius:this.options.pointSize});this.options.pointTooltipOnRightPanel?O(s,this.options,r.$datasource,this.options.autocloseTooltip,this.options.showTooltipAction,e(r,u)):s.on("click",()=>e(r,u)),this.points.addLayer(s)}}t.length&&this.map.addLayer(this.points)}updatePolylines(t,e,i=!0){let o=[];t.forEach((r,u)=>{let s=e[u];r.length&&s.entityName===r[0].entityName&&(this.polylines.get(s.entityName)?this.updatePolyline(s,r,e,this.options,i):this.createPolyline(s,r,e,this.options,i),o.push(s.entityName))});let n=[];this.polylines.forEach((r,u)=>{o.includes(u)||n.push(u)}),n.forEach(r=>{this.removePolyline(r)})}createPolyline(t,e,i,o,n=!0){let r=new pt(this.map,e.map(u=>this.extractPosition(u)).filter(u=>!!u).map(u=>this.positionToLatLng(u)),t,i,o);if(n){let u=r.leafletPoly.getBounds();this.fitBounds(u)}this.polylines.set(t.entityName,r)}updatePolyline(t,e,i,o,n=!0){let r=this.polylines.get(t.entityName),u=r.leafletPoly.getBounds();r.updatePolyline(e.map(a=>this.extractPosition(a)).filter(a=>!!a).map(a=>this.positionToLatLng(a)),t,i,o);let s=r.leafletPoly.getBounds();n&&u.toBBoxString()!==s.toBBoxString()&&this.fitBounds(s)}removePolyline(t){let e=this.polylines.get(t);e&&(this.map.removeLayer(e.leafletPoly),e.polylineDecorator&&this.map.removeLayer(e.polylineDecorator),this.polylines.delete(t))}isValidPolygonPosition(t){return t&&(q(t[this.options.polygonKeyName])&&!Dt(t[this.options.polygonKeyName])||Array.isArray(t[this.options.polygonKeyName]))}updatePolygons(t,e=!0){let i=[];this.polygonsData=Wt(t),t.forEach(n=>{this.isValidPolygonPosition(n)&&(X(n[this.options.polygonKeyName])&&(n[this.options.polygonKeyName]=JSON.parse(n[this.options.polygonKeyName])),n[this.options.polygonKeyName]=this.convertPositionPolygon(n[this.options.polygonKeyName]),this.polygons.get(n.entityName)?this.updatePolygon(n,t,this.options,e):this.createPolygon(n,t,this.options,e,this.options.snappable),i.push(n.entityName))});let o=[];this.polygons.forEach((n,r)=>{i.includes(r)||o.push(r)}),o.forEach(n=>{this.removePolygon(n)})}createPolygon(t,e,i,o=!0,n=!1){let r=new ut(this,t,e,i,this.dragPolygonVertex,n);if(o){let u=r.leafletPoly.getBounds();this.fitBounds(u)}this.map.pm.globalDragModeEnabled()&&r.leafletPoly.pm&&r.leafletPoly.pm.enableLayerDrag(),this.polygons.set(t.entityName,r)}updatePolygon(t,e,i,o=!0){let n=this.polygons.get(t.entityName),r=n.leafletPoly.getBounds();n.updatePolygon(t,e,i);let u=n.leafletPoly.getBounds();o&&r.toBBoxString()!==u.toBBoxString()&&this.fitBounds(u)}removePolygon(t){let e=this.polygons.get(t);e&&(this.map.removeLayer(e.leafletPoly),this.polygons.delete(t))}remove(){this.map&&(this.map.remove(),this.map=null),this.tooltipInstances.forEach(t=>{t.destroy()})}isValidCircle(t){return t&&q(t[this.options.circleKeyName])&&Dt(t[this.options.circleKeyName])}convertCircleToCustomFormat(t,e){let i=null;if(t){let o=tt(t,this.southWest,this.northEast);i={latitude:o.lat,longitude:o.lng,radius:e}}return{[this.options.circleKeyName]:i}}convertToCircleFormat(t){let e=tt(new b.default.LatLng(t.latitude,t.longitude),this.southWest,this.northEast);return t.latitude=e.lat,t.longitude=e.lng,t}updateCircle(t,e=!0){let i=new Set(Array.from(this.circles.keys()));t.filter(n=>this.isValidCircle(n)).forEach(n=>{this.circles.get(n.entityName)?this.updatedCircle(n,t,e):this.createdCircle(n,t,e),i.delete(n.entityName)}),i.forEach(n=>{this.removeCircle(n)}),this.circleData=t}updatedCircle(t,e,i=!0){let o=this.circles.get(t.entityName),n=o.leafletCircle.getBounds();o.updateCircle(t,e);let r=o.leafletCircle.getBounds();i&&n.toBBoxString()!==r.toBBoxString()&&this.fitBounds(r)}createdCircle(t,e,i=!0){let o=new dt(this,t,e,this.options,this.dragCircleVertex,this.options.snappable);if(i){let n=o.leafletCircle.getBounds();this.fitBounds(n)}this.map.pm.globalDragModeEnabled()&&o.leafletCircle.pm&&o.leafletCircle.pm.enableLayerDrag(),this.circles.set(t.entityName,o)}removeCircle(t){let e=this.circles.get(t);e&&(this.map.removeLayer(e.leafletCircle),this.circles.delete(t))}};var ft=class extends S{constructor(t,e,i){super(t,e,i);let o=mt.default.map(e,{doubleClickZoom:!this.options.disableDoubleClickZooming,zoomControl:!this.options.disableZoomControl}).setView(i?.parsedDefaultCenterPosition,i?.defaultZoomLevel||8),n;i.useCustomProvider?n=mt.default.tileLayer(i.customProviderTileUrl):n=mt.default.tileLayer.provider(i.mapProvider||"OpenStreetMap.Mapnik"),n.addTo(o),super.setMap(o)}};g();var At=w(_());var gt=class extends S{constructor(t,e,i){super(t,e,i);let o="https://rt{s}.map.gtimg.com/realtimerender?z={z}&x={x}&y={y}&type=vector&style=0",n=At.default.map(e,{doubleClickZoom:!this.options.disableDoubleClickZooming,zoomControl:!this.options.disableZoomControl}).setView(i?.parsedDefaultCenterPosition,i?.defaultZoomLevel||8);At.default.tileLayer(o,{subdomains:"0123",tms:!0,attribution:"&copy;2024 Tencent - GS(2023)1171\u53F7"}).addTo(n).addTo(n),super.setMap(n)}};g();var Et=w(_());g();(function(){"use strict";var c=Symbol("newer"),t=Symbol("older"),e=function(a,l){typeof a!="number"&&(l=a,a=0),this.size=0,this.limit=a,this.oldest=this.newest=void 0,this._keymap=new Map,l&&(this.assign(l),a<1&&(this.limit=this.size))};e.prototype._markEntryAsUsed=function(a){a!==this.newest&&(a[c]&&(a===this.oldest&&(this.oldest=a[c]),a[c][t]=a[t]),a[t]&&(a[t][c]=a[c]),a[c]=void 0,a[t]=this.newest,this.newest&&(this.newest[c]=a),this.newest=a)},e.prototype.assign=function(a){var l,p=this.limit||Number.MAX_VALUE;this._keymap.clear();for(var h=a[Symbol.iterator](),d=h.next();!d.done;d=h.next()){var m=new i(d.value[0],d.value[1]);if(this._keymap.set(m.key,m),l?(l[c]=m,m[t]=l):this.oldest=m,l=m,p--==0)throw new Error("overflow")}this.newest=l,this.size=this._keymap.size},e.prototype.get=function(a){var l=this._keymap.get(a);if(l)return this._markEntryAsUsed(l),l.value},e.prototype.set=function(a,l){var p=this._keymap.get(a);return p?(p.value=l,this._markEntryAsUsed(p),this):(this._keymap.set(a,p=new i(a,l)),this.newest?(this.newest[c]=p,p[t]=this.newest):this.oldest=p,this.newest=p,++this.size,this.size>this.limit&&this.shift(),this)},e.prototype.shift=function(){var a=this.oldest;if(a)return this.oldest[c]?(this.oldest=this.oldest[c],this.oldest[t]=void 0):(this.oldest=void 0,this.newest=void 0),a[c]=a[t]=void 0,this._keymap.delete(a.key),--this.size,[a.key,a.value]},e.prototype.find=function(a){var l=this._keymap.get(a);return l?l.value:void 0},e.prototype.has=function(a){return this._keymap.has(a)},e.prototype.delete=function(a){var l=this._keymap.get(a);if(l)return this._keymap.delete(l.key),l[c]&&l[t]?(l[t][c]=l[c],l[c][t]=l[t]):l[c]?(l[c][t]=void 0,this.oldest=l[c]):l[t]?(l[t][c]=void 0,this.newest=l[t]):this.oldest=this.newest=void 0,this.size--,l.value},e.prototype.clear=function(){this.oldest=this.newest=void 0,this.size=0,this._keymap.clear()},e.prototype.keys=function(){return new n(this.oldest)},e.prototype.values=function(){return new r(this.oldest)},e.prototype.entries=function(){return this},e.prototype[Symbol.iterator]=function(){return new o(this.oldest)},e.prototype.forEach=function(a,l){typeof l!="object"&&(l=this);for(var p=this.oldest;p;)a.call(l,p.value,p.key,this),p=p[c]},e.prototype.toJSON=function(){for(var a=new Array(this.size),l=0,p=this.oldest;p;)a[l++]={key:p.key,value:p.value},p=p[c];return a},e.prototype.toString=function(){for(var a="",l=this.oldest;l;)a+=String(l.key)+":"+l.value,l=l[c],l&&(a+=" < ");return a};function i(s,a){this.key=s,this.value=a,this[c]=void 0,this[t]=void 0}function o(s){this.entry=s}o.prototype[Symbol.iterator]=function(){return this},o.prototype.next=function(){var s=this.entry;return s?(this.entry=s[c],{done:!1,value:[s.key,s.value]}):{done:!0,value:void 0}};function n(s){this.entry=s}n.prototype[Symbol.iterator]=function(){return this},n.prototype.next=function(){var s=this.entry;return s?(this.entry=s[c],{done:!1,value:s.key}):{done:!0,value:void 0}};function r(s){this.entry=s}r.prototype[Symbol.iterator]=function(){return this},r.prototype.next=function(){var s=this.entry;return s?(this.entry=s[c],{done:!1,value:s.value}):{done:!0,value:void 0}};function u(s,a){var l=0,p=null;p=setInterval(function(){if(l>=20)throw clearInterval(p),new Error("window.google not found after 10 seconds");window.google&&window.google.maps&&window.google.maps.Map&&(clearInterval(p),s.call(a)),++l},500)}L.GridLayer.GoogleMutant=L.GridLayer.extend({options:{maxZoom:21,type:"roadmap",maxNativeZoom:21},initialize:function(s){L.GridLayer.prototype.initialize.call(this,s),this._tileCallbacks={},this._lru=new e(100),this._imagesPerTile=1,this._boundOnMutatedImage=this._onMutatedImage.bind(this)},onAdd:function(s){var a=this;L.GridLayer.prototype.onAdd.call(this,s),this._initMutantContainer(),this._logoContainer&&s._controlCorners.bottomleft.appendChild(this._logoContainer),this._attributionContainer&&s._controlCorners.bottomright.appendChild(this._attributionContainer),u(function(){a._map&&(a._initMutant(),google.maps.event.addListenerOnce(a._mutant,"idle",function(){a._map&&(a._checkZoomLevels(),a._mutantIsReady=!0)}))})},onRemove:function(s){L.GridLayer.prototype.onRemove.call(this,s),this._observer.disconnect(),s._container.removeChild(this._mutantContainer),this._logoContainer&&L.DomUtil.remove(this._logoContainer),this._attributionContainer&&L.DomUtil.remove(this._attributionContainer),this._mutant&&google.maps.event.clearListeners(this._mutant,"idle")},addGoogleLayer:function(s,a){var l=this;return this._subLayers||(this._subLayers={}),this.whenReady(function(){var p=google.maps[s],h=new p(a);h.setMap(l._mutant),l._subLayers[s]=h}),this},removeGoogleLayer:function(s){var a=this;return this.whenReady(function(){var l=a._subLayers&&a._subLayers[s];l&&(l.setMap(null),delete a._subLayers[s])}),this},_initMutantContainer:function(){this._mutantContainer||(this._mutantContainer=L.DomUtil.create("div","leaflet-google-mutant leaflet-top leaflet-left"),this._mutantContainer.id="_MutantContainer_"+L.Util.stamp(this._mutantContainer),this._mutantContainer.style.pointerEvents="none",this._mutantContainer.style.visibility="hidden",L.DomEvent.off(this._mutantContainer)),this._map.getContainer().appendChild(this._mutantContainer),this.setOpacity(this.options.opacity);var s=this._mutantContainer.style;this._map.options.zoomSnap<1?(s.width="180%",s.height="180%"):(s.width="100%",s.height="100%"),s.zIndex=-1,this._attachObserver(this._mutantContainer)},_initMutant:function(){if(!this._mutant){var s={center:{lat:0,lng:0},zoom:0,tilt:0,mapTypeId:this.options.type,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,styles:this.options.styles||[],backgroundColor:"transparent"};this.options.mapId!=null&&(s.mapId=this.options.mapId);var a=new google.maps.Map(this._mutantContainer,s);this._mutant=a,this._update(),this.fire("spawned",{mapObject:a}),this._waitControls(),this.once("controls_ready",this._setupAttribution)}},_attachObserver:function(a){this._observer||(this._observer=new MutationObserver(this._onMutations.bind(this))),this._observer.observe(a,{childList:!0,subtree:!0}),Array.prototype.forEach.call(a.querySelectorAll("img"),this._boundOnMutatedImage)},_waitControls:function(){var s=this,a=setInterval(function(){var l=s._mutant.__gm.layoutManager;if(l){clearInterval(a);var p;Object.keys(l).forEach(function(h){var d=l[h];d.get&&d.get(1)instanceof Node&&(p=d)}),s.fire("controls_ready",{positions:p})}},50)},_setupAttribution:function(s){if(this._map){var a=google.maps.ControlPosition,l=this._attributionContainer=s.positions.get(a.BOTTOM_RIGHT);L.DomUtil.addClass(l,"leaflet-control leaflet-control-attribution"),L.DomEvent.disableClickPropagation(l),l.style.height="14px",this._map._controlCorners.bottomright.appendChild(l),this._logoContainer=s.positions.get(a.BOTTOM_LEFT),this._logoContainer.style.pointerEvents="auto",this._map._controlCorners.bottomleft.appendChild(this._logoContainer)}},_onMutations:function(a){for(var l=0;l<a.length;++l)for(var p=a[l],h=0;h<p.addedNodes.length;++h){var d=p.addedNodes[h];d instanceof HTMLImageElement?this._onMutatedImage(d):d instanceof HTMLElement&&Array.prototype.forEach.call(d.querySelectorAll("img"),this._boundOnMutatedImage)}},_roadRegexp:/!1i(\d+)!2i(\d+)!3i(\d+|VinaFnapurmBegrtn)!/,_satRegexp:/x=(\d+)&y=(\d+)&z=(\d+|VinaFnapurmBegrtn)/,_onMutatedImage:function(a){var l,p=a.src.match(this._roadRegexp),h=0;if(p?(l={z:p[1],x:p[2],y:p[3]},this._imagesPerTile>1&&(a.style.zIndex=1,h=1)):(p=a.src.match(this._satRegexp),p&&(l={x:p[1],y:p[2],z:p[3]}),h=0),l){var d=this._tileCoordsToKey(l);a.style.position="absolute";var m=d+"/"+h;this._lru.set(m,a),m in this._tileCallbacks&&this._tileCallbacks[m]&&(this._tileCallbacks[m].forEach(function(f){return f(a)}),delete this._tileCallbacks[m])}},createTile:function(s,a){var l=this._tileCoordsToKey(s),p=L.DomUtil.create("div");p.style.textAlign="left",p.dataset.pending=this._imagesPerTile,a=a.bind(this,null,p);for(var h=0;h<this._imagesPerTile;++h){var d=l+"/"+h,m=this._lru.get(d);m?(p.appendChild(this._clone(m)),--p.dataset.pending):(this._tileCallbacks[d]=this._tileCallbacks[d]||[],this._tileCallbacks[d].push(function(f){return function(y){f.appendChild(this._clone(y)),--f.dataset.pending,parseInt(f.dataset.pending)||a()}.bind(this)}.bind(this)(p)))}return parseInt(p.dataset.pending)||L.Util.requestAnimFrame(a),p},_clone:function(s){var a=s.cloneNode(!0);return a.style.visibility="visible",a},_checkZoomLevels:function(){var s=this._map.getZoom(),a=this._mutant.getZoom();!s||!a||(a!==s||a>this.options.maxNativeZoom)&&this._setMaxNativeZoom(a)},_setMaxNativeZoom:function(s){s!==this.options.maxNativeZoom&&(this.options.maxNativeZoom=s,this._resetView())},_update:function(s){if(this._mutant){s=s||this._map.getCenter();var a=new google.maps.LatLng(s.lat,s.lng),l=Math.round(this._map.getZoom()),p=this._mutant.getZoom();this._mutant.setCenter(a),l!==p&&(this._mutant.setZoom(l),this._mutantIsReady&&this._checkZoomLevels())}L.GridLayer.prototype._update.call(this,s)},whenReady:function(s,a){return this._mutant?s.call(a||this,{target:this}):this.on("spawned",s,a),this}}),L.gridLayer.googleMutant=function(s){return new L.GridLayer.GoogleMutant(s)}})();var Bt={},yt=class extends S{constructor(t,e,i){super(t,e,i),this.resource=t.$injector.get(Qt),this.loadGoogle(()=>{let o=Et.default.map(e,{attributionControl:!1,doubleClickZoom:!this.options.disableDoubleClickZooming,zoomControl:!this.options.disableZoomControl}).setView(i?.parsedDefaultCenterPosition,i?.defaultZoomLevel||8);Et.default.gridLayer.googleMutant({type:i?.gmDefaultMapType||"roadmap"}).addTo(o),super.setMap(o)},i.gmApiKey)}loadGoogle(t,e="AIzaSyDoEx2kaGz3PxwbI9T7ccTSg5xjdw8Nw8Q"){Bt[e]?t():this.resource.loadResource(`https://maps.googleapis.com/maps/api/js?key=${e}`).subscribe({next:()=>{Bt[e]=!0,t()},error:i=>{Bt[e]=!1,console.error("Google map api load failed!",i)}})}};g();var Ot=w(_());var bt=class extends S{constructor(t,e,i){super(t,e,i);let o=Ot.default.map(e,{doubleClickZoom:!this.options.disableDoubleClickZooming,zoomControl:!this.options.disableZoomControl}).setView(i?.parsedDefaultCenterPosition,i?.defaultZoomLevel||8),n=i.mapProviderHere||"HERE.normalDay";i.credentials.useV3&&x(i.credentials.apiKey)&&(n=i.mapProviderHere?.replace("HERE","HEREv3")||"HEREv3.normalDay"),Ot.default.tileLayer.provider(n,i.credentials).addTo(o),super.setMap(o)}};g();var U=w(_());var it=4,Ct=class extends S{constructor(t,e,i){super(t,e,i),this.aspect=0,this.width=0,this.height=0;let o={posFunction:P(this.ctx.http,i.posFunction,["origXPos","origYPos","data","dsData","dsIndex","aspect"]),mapImage:this.mapImage(i)};Vt(o).subscribe(n=>{this.posFunction=n.posFunction;let r=n.mapImage;this.imageUrl=r.imageUrl,this.aspect=r.aspect,r.update?this.onResize(!0):(this.onResize(),super.setMap(this.map))})}mapImage(t){let e=t.imageEntityAlias,i=t.imageUrlAttribute;if(!e||!i)return this.imageFromUrl(t.mapImageUrl);let o=this.ctx.aliasController.getEntityAliasId(e);if(!o)return this.imageFromUrl(t.mapImageUrl);let n=[{type:Xt.entity,name:e,aliasName:e,entityAliasId:o,dataKeys:[{type:J.attribute,name:i,label:i,settings:{},_hash:Math.random()}]}],r=new nt,u=!1,s={datasources:n,hasDataPageLink:!0,singleEntity:!0,useDashboardTimewindow:!1,type:qt.latest,callbacks:{onDataUpdated:a=>{q(a.data[0]?.data[0]?.[1])?r.next([a.data[0].data,u]):r.next([[[0,t.mapImageUrl]],u]),u=!0}}};return this.ctx.subscriptionApi.createSubscription(s,!0).subscribe(a=>{let l={page:0,pageSize:1,textSearch:null,dynamic:!0};a.subscribeAllForPaginatedData(l,null)}),this.imageFromAlias(r)}imageFromUrl(t,e=!1){return Q(this.ctx.$injector.get(V),t).pipe(at(i=>i?I({imageUrl:i.url,aspect:i.aspect,update:e}):this.imageFromUrl(Y.mapImageUrl,e)),kt(()=>this.imageFromUrl(Y.mapImageUrl,e)))}imageFromAlias(t){return t.pipe(at(e=>{let i=e[1],o=e[0][0][1],n={imageUrl:null,aspect:null,update:i};return Q(this.ctx.$injector.get(V),o).pipe(at(r=>r?(n.aspect=r.aspect,n.imageUrl=r.url,I(n)):this.imageFromUrl(Y.mapImageUrl,i)),kt(()=>this.imageFromUrl(Y.mapImageUrl,i)))}))}updateBounds(t,e){let i=this.width,o=this.height;this.southWest=this.pointToLatLng(0,o),this.northEast=this.pointToLatLng(i,0);let n=new U.default.LatLngBounds(this.southWest,this.northEast);t&&this.imageOverlay&&(this.imageOverlay.remove(),this.imageOverlay=null),this.imageOverlay?this.imageOverlay.setBounds(n):this.imageOverlay=U.default.imageOverlay(this.imageUrl,n).addTo(this.map);let r=200*it,u=this.pointToLatLng(-r,o+r),s=this.pointToLatLng(i+r,-r),a=new U.default.LatLngBounds(u,s);if(this.map._enforcingBounds=!0,this.map.setMaxBounds(a),e){e.x*=i,e.y*=o;let l=this.pointToLatLng(e.x,e.y);this.map.panTo(l,{animate:!1})}this.map._enforcingBounds=!1}onResize(t){let e=this.$container.clientWidth;if(e>0&&this.aspect){let i=Math.round(e/this.aspect),o=this.$container.clientHeight;o>0&&i>o&&(i=o,e=Math.round(i*this.aspect)),e*=it;let n=this.width,r=this.height;if(this.width!==e||t)if(this.width=e,this.height=Math.round(e/this.aspect),!this.map)this.initMap(t);else{let u=this.latLngToPoint(this.map.getCenter());u.x/=n,u.y/=r,this.updateBounds(t,u),this.map._enforcingBounds=!0,this.map.invalidateSize(!1),this.map._enforcingBounds=!1,this.updateMarkers(this.markersData),this.options.showPolygon&&this.updatePolygons(this.polygonsData),this.options.showCircle&&this.updateCircle(this.circleData)}}}fitBounds(t,e){}initMap(t){if(!this.map&&this.aspect>0){let e=this.pointToLatLng(this.width/2,this.height/2);this.map=U.default.map(this.$container,{minZoom:1,maxZoom:it,scrollWheelZoom:!this.options.disableScrollZooming,center:e,doubleClickZoom:!this.options.disableDoubleClickZooming,zoomControl:!this.options.disableZoomControl,zoom:1,crs:U.default.CRS.Simple,attributionControl:!1}),this.updateBounds(t)}}extractPosition(t){if(!t)return null;let e=t[this.options.xPosKeyName],i=t[this.options.yPosKeyName];return!x(e)||Mt(e)||isNaN(e)||!x(i)||Mt(i)||isNaN(i)?null:{x:e,y:i}}positionToLatLng(t){return this.pointToLatLng(t.x*this.width,t.y*this.height)}convertPosition(t,e){let i=this.extractPosition(t);if(i){let o=this.posFunction.execute(i.x,i.y,t,e,t.dsIndex,this.aspect)||{x:0,y:0};return this.positionToLatLng(o)}else return null}convertPositionPolygon(t){return t.map(e=>!Array.isArray(e[0])&&!Array.isArray(e[1])&&e.length===2?this.pointToLatLng(e[0]*this.width,e[1]*this.height):Array.isArray(e)&&e.length?this.convertPositionPolygon(e):null).filter(e=>!!e)}pointToLatLng(t,e){return U.default.CRS.Simple.pointToLatLng({x:t,y:e},it-1)}latLngToPoint(t){return U.default.CRS.Simple.latLngToPoint(t,it-1)}convertToCustomFormat(t,e=0,i=this.width,o=this.height){if(!t)return{[this.options.xPosKeyName]:null,[this.options.yPosKeyName]:null};let n=this.latLngToPoint(t),r=R(n.x,i),u=R(n.y,o);return r===0?n.x=0:r===1&&(n.x=i),u===0?n.y=0:u===1&&(n.y=o),{[this.options.xPosKeyName]:r,[this.options.yPosKeyName]:u}}convertToPolygonFormat(t,e=this.width,i=this.height){return t.length?t.map(o=>{if(o.length)return this.convertToPolygonFormat(o,e,i);{let n=this.latLngToPoint(o);return[R(n.x,e),R(n.y,i)]}}):[]}convertPolygonToCustomFormat(t){let e=t?this.convertToPolygonFormat(t):null;return{[this.options.polygonKeyName]:e}}convertCircleToCustomFormat(t,e,i=this.width,o=this.height){let n=null;if(t){let r=this.latLngToPoint(t),u=R(r.x,i),s=R(r.y,o),a=R(e,i);n={latitude:u,longitude:s,radius:a}}return{[this.options.circleKeyName]:n}}convertToCircleFormat(t,e=this.width,i=this.height){let o=this.pointToLatLng(t.latitude*e,t.longitude*i);return t.latitude=o.lat,t.longitude=o.lng,t.radius=t.radius*e,t}};var he={"openstreet-map":ft,"tencent-map":gt,"google-map":yt,here:bt,"image-map":Ct};var ce=w(_());var Nt=class{constructor(t,e,i,o,n=!1,r){this.mapProvider=t,this.drawRoutes=e,this.ctx=i,this.updatePending=!1,this.latestUpdatePending=!1,this.resizePending=!1,this.destroyed=!1,this.translate=(u,s)=>u?this.ctx.$injector.get(Jt).customTranslation(u,s||u)||this.ctx.$injector.get(rt).instant(u):"",this.map&&(this.map.map.remove(),delete this.map),this.data=i.data,o||(o=i.$container[0]),Ut(this.initSettings(i.settings,n)).subscribe(u=>{if(!this.destroyed){this.settings=u,this.settings.tooltipAction=this.getDescriptors("tooltipAction"),this.settings.markerClick=this.getDescriptors("markerClick"),this.settings.polygonClick=this.getDescriptors("polygonClick"),this.settings.circleClick=this.getDescriptors("circleClick");let s=he[this.provider];if(!s)return;T.setTranslate(this.translate),this.map=new s(this.ctx,o,this.settings),this.ctx.mapInstance=this.map,this.map.saveMarkerLocation=this.setMarkerLocation.bind(this),this.map.savePolygonLocation=this.savePolygonLocation.bind(this),this.map.saveLocation=this.saveLocation.bind(this);let a=this.settings.mapPageSize;x(this.ctx.widgetConfig.pageSize)&&(a=Math.max(a,this.ctx.widgetConfig.pageSize)),this.pageLink={page:0,pageSize:a,textSearch:null,dynamic:!0},this.map.setLoading(!0),this.ctx.defaultSubscription.paginatedDataSubscriptionUpdated.subscribe(()=>{this.map.resetState()}),this.ctx.defaultSubscription.subscribeAllForPaginatedData(this.pageLink,null),this.updatePending&&this.update(),this.latestUpdatePending&&this.latestDataUpdate(),this.resizePending&&this.resize(),r&&r(this.map)}})}static actionSources(){return{markerClick:{name:"widget-action.marker-click",multiple:!1},polygonClick:{name:"widget-action.polygon-click",multiple:!1},circleClick:{name:"widget-action.circle-click",multiple:!1},tooltipAction:{name:"widget-action.tooltip-tag-action",multiple:!0}}}getDescriptors(t){let e=this.ctx.actionsApi.getActionDescriptors(t),i={};return e.forEach(o=>{i[o.name]=(n,r)=>this.onCustomAction(o,n,r)},i),i}onInit(){}onCustomAction(t,e,i){e&&(e.preventDefault(),e.stopPropagation());let{entityId:o,entityName:n,entityLabel:r,entityType:u}=i;this.ctx.actionsApi.handleWidgetAction(e,t,{entityType:u,id:o},n,null,r)}setMarkerLocation(t,e,i){let o;if(A(e)&&A(i)){let n=e!=null&&i!==null?ce.default.latLng(e,i):null;o=this.map.convertToCustomFormat(n)}else this.settings.provider!==ee.image?o={[this.settings.latKeyName]:t[this.settings.latKeyName],[this.settings.lngKeyName]:t[this.settings.lngKeyName]}:o={[this.settings.xPosKeyName]:t[this.settings.xPosKeyName],[this.settings.yPosKeyName]:t[this.settings.yPosKeyName]};return this.saveLocation(t,o)}savePolygonLocation(t,e){let i;return A(e)?i=this.map.convertToPolygonFormat(e):i={[this.settings.polygonKeyName]:t[this.settings.polygonKeyName]},this.saveLocation(t,i)}saveLocation(t,e){let i=this.ctx.$injector.get(te),o=[],n=[],r={entityType:t.$datasource.entityType,id:t.$datasource.entityId},u=t.$datasource.dataKeys;t.$datasource.latestDataKeys&&(u=u.concat(t.$datasource.latestDataKeys));for(let a of Object.keys(e))for(let l of u)if(a===l.name){let p={key:l.name,value:e[a]};l.type===J.attribute?o.push(p):l.type===J.timeseries&&n.push(p);break}let s=[];return n.length&&s.push(i.saveEntityTimeseries(r,Ht.LATEST_TELEMETRY,n)),o.length&&s.push(i.saveEntityAttributes(r,$t.SERVER_SCOPE,o)),s.length?Kt(s):I(null)}initSettings(t,e){return Rt(this,null,function*(){let i=["data","dsData","dsIndex"];this.provider=t.provider||this.mapProvider;let o={provider:this.provider,parsedLabelFunction:yield v(P(this.ctx.http,t.labelFunction,i)),parsedTooltipFunction:yield v(P(this.ctx.http,t.tooltipFunction,i)),parsedColorFunction:yield v(P(this.ctx.http,t.colorFunction,i)),parsedColorPointFunction:yield v(P(this.ctx.http,t.colorPointFunction,i)),parsedStrokeOpacityFunction:yield v(P(this.ctx.http,t.strokeOpacityFunction,i)),parsedStrokeWeightFunction:yield v(P(this.ctx.http,t.strokeWeightFunction,i)),parsedPolygonLabelFunction:yield v(P(this.ctx.http,t.polygonLabelFunction,i)),parsedPolygonColorFunction:yield v(P(this.ctx.http,t.polygonColorFunction,i)),parsedPolygonStrokeColorFunction:yield v(P(this.ctx.http,t.polygonStrokeColorFunction,i)),parsedPolygonTooltipFunction:yield v(P(this.ctx.http,t.polygonTooltipFunction,i)),parsedCircleLabelFunction:yield v(P(this.ctx.http,t.circleLabelFunction,i)),parsedCircleStrokeColorFunction:yield v(P(this.ctx.http,t.circleStrokeColorFunction,i)),parsedCircleFillColorFunction:yield v(P(this.ctx.http,t.circleFillColorFunction,i)),parsedCircleTooltipFunction:yield v(P(this.ctx.http,t.circleTooltipFunction,i)),parsedMarkerImageFunction:yield v(P(this.ctx.http,t.markerImageFunction,["data","images","dsData","dsIndex"])),parsedClusterMarkerFunction:yield v(P(this.ctx.http,t.clusterMarkerFunction,["data","childCount"])),polygonKeyName:t.polKeyName?t.polKeyName:t.polygonKeyName,tooltipPattern:t.tooltipPattern||"<b>${entityName}</b><br/><br/><b>Latitude:</b> ${"+t.latKeyName+":7}<br/><b>Longitude:</b> ${"+t.lngKeyName+":7}",parsedDefaultCenterPosition:ie(t?.defaultCenterPosition),currentImage:t.markerImage?.length?{url:t.markerImage,size:t.markerImageSize||34}:null};return e&&!t.hasOwnProperty("draggableMarker")&&(o.draggableMarker=!0),e&&!t.hasOwnProperty("editablePolygon")&&(o.editablePolygon=!0),o.minZoomLevel=16,st(st(st({},lt),t),o)})}update(){this.map?(this.updatePending=!1,this.map.updateData(this.drawRoutes),this.map.setLoading(!1)):this.updatePending=!0}latestDataUpdate(){this.map?(this.latestUpdatePending=!1,this.map.updateData(this.drawRoutes)):this.latestUpdatePending=!0}resize(){this.map?(this.resizePending=!1,this.map.onResize(),this.map.invalidateSize()):this.resizePending=!0}destroy(){this.destroyed=!0,this.map&&this.map.remove(),this.ctx.mapInstance=null}},to=Nt;export{Nt as MapWidgetController,to as TbMapWidgetV2};
