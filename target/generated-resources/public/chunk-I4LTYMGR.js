import{F as ot,G as A,H as F,I as st,L as z,n as at}from"./chunk-GBVWTJHZ.js";import{A as nt}from"./chunk-QR6ZNJZ6.js";import{f as G,nc as it,uc as et}from"./chunk-HBCL52P7.js";import{D as mt}from"./chunk-HA3FE6NY.js";import{A as g,Ac as l,Bc as h,Cc as _,Eh as tt,Gc as I,Ib as E,Jb as v,Jc as O,Jd as Q,Lc as u,Pb as c,Qb as w,Qe as rt,Sc as V,Ta as N,Tc as K,Uc as Y,Zc as $,ah as J,bh as X,cb as M,db as y,fh as Z,hg as d,jc as f,je as q,jg as T,ke as B,kh as x,lh as b,oc as p,pc as R,qc as j,v as k}from"./chunk-PQ6EZO2H.js";import{a as m,b as P,g as W,h as U,i as S}from"./chunk-GHMOB5KC.js";S();var L=W(rt());var H=W(mt());var pt=["map"];function lt(s,C){if(s&1&&_(0,"div",10),s&2){let e=u();p("innerHTML",e.label,v)}}function ct(s,C){if(s&1){let e=I();l(0,"button",11),O("click",function(){M(e);let t=u();return y(t.visibleTooltip=!t.visibleTooltip)}),l(1,"mat-icon"),$(2,"info_outline"),h()()}}function ht(s,C){if(s&1&&_(0,"div",12),s&2){let e=C.$implicit;p("innerHTML",e,v)}}function dt(s,C){if(s&1){let e=I();l(0,"tb-history-selector",13),O("timeUpdated",function(t){M(e);let n=u();return y(n.timeUpdated(t))}),h()}if(s&2){let e=u();p("settings",e.settings)("minTime",e.minTime)("maxTime",e.maxTime)("step",e.normalizationStep)("anchors",e.anchors)("useAnchors",e.useAnchors)}}var gt=(()=>{class s{constructor(e,i){this.cd=e,this.sanitizer=i,this.initialized=!1,this.updatePending=!1,this.mapWidgetUpdatePending=!1,this.interpolatedTimeData=[],this.formattedInterpolatedTimeData=[],this.formattedCurrentPosition=[],this.formattedLatestData=[],this.mainTooltips=[],this.visibleTooltip=!1,this.anchors=[],this.calcTooltip=(t,n)=>{let a=t||this.activeTrip,o=this.settings.useTooltipFunction?b(this.settings.parsedTooltipFunction,[a,n,t.dsIndex]):this.settings.tooltipPattern;return z.parseTemplate(o,a,!0)},this.findFirstHistoricalDataIndexCoordinate=t=>T(t[this.settings.latKeyName])&&T(t[this.settings.lngKeyName])}ngOnInit(){this.widgetConfig=this.ctx.widgetConfig,this.settings=m(m({buttonColor:tt(this.widgetConfig.color).setAlpha(.54).toRgbString()},ot),this.ctx.settings),this.useAnchors=this.settings.showPoints&&this.settings.usePointAsAnchor,this.normalizationStep=this.settings.normalizationStep;let e=this.ctx.defaultSubscription;e.callbacks.onDataUpdated=()=>{this.update()},e.callbacks.onLatestDataUpdated=()=>{this.latestDataUpdate()},k(this.initializeFunctions()).subscribe(()=>{this.initialized=!0,this.updatePending&&this.updateCurrentData()})}ngAfterViewInit(){import("./chunk-Z4UJHNAY.js").then(e=>{this.mapWidget=new e.MapWidgetController(at.openstreet,!1,this.ctx,this.mapContainer.nativeElement,!1,()=>{this.mapWidgetUpdatePending&&this.updateMapWidget()}),this.mapResize$=new ResizeObserver(()=>{this.mapWidget.resize()}),this.mapResize$.observe(this.mapContainer.nativeElement)})}ngOnDestroy(){this.mapResize$&&this.mapResize$.disconnect()}timeUpdated(e){this.currentTime=e,this.formattedCurrentPosition=this.interpolatedTimeData.map(i=>i[e]);for(let i=0;i<this.interpolatedTimeData.length;i++)if(d(this.formattedCurrentPosition[i])){let t=Object.keys(this.interpolatedTimeData[i]).map(n=>parseInt(n,10));for(let n=1;n<t.length;n++)if(t[n-1]<e&&t[n]>e){let a=this.interpolatedTimeData[i][t[n-1]],o=this.interpolatedTimeData[i][t[n]],r=A(t[n-1],t[n],e);this.formattedCurrentPosition[i]=m(P(m({},a),{time:e}),F(a,o,this.settings.latKeyName,this.settings.lngKeyName,r));break}}for(let i=0;i<this.interpolatedTimeData.length;i++)d(this.formattedCurrentPosition[i])&&(this.formattedCurrentPosition[i]=this.calculateLastPoints(this.interpolatedTimeData[i],e));this.updateCurrentData()}initializeFunctions(){return U(this,null,function*(){this.settings.parsedPointAsAnchorFunction=yield g(x(this.ctx.http,this.settings.pointAsAnchorFunction,["data","dsData","dsIndex"])),this.settings.parsedTooltipFunction=yield g(x(this.ctx.http,this.settings.tooltipFunction,["data","dsData","dsIndex"])),this.settings.parsedLabelFunction=yield g(x(this.ctx.http,this.settings.labelFunction,["data","dsData","dsIndex"])),this.settings.parsedColorPointFunction=yield g(x(this.ctx.http,this.settings.colorPointFunction,["data","dsData","dsIndex"]))})}update(){this.historicalData=X(this.ctx.data).map(n=>this.clearIncorrectFirsLastDatapoint(n)).filter(n=>n.length),this.interpolatedTimeData.length=0,this.formattedInterpolatedTimeData.length=0;let e=this.minTime,i=this.maxTime;this.calculateIntervals();let t=this.calculateCurrentTime(e,i);t!==this.currentTime&&this.timeUpdated(t),this.updateMapWidget()}latestDataUpdate(){this.formattedLatestData=J(this.ctx.latestData),this.updateCurrentData()}updateMapWidget(){this.mapWidget?.map?(this.mapWidgetUpdatePending=!1,this.mapWidget.map.map?.invalidateSize(),this.mapWidget.map.setLoading(!1),this.cd.detectChanges()):this.mapWidgetUpdatePending=!0}updateCurrentData(){if(this.initialized){this.updatePending=!1;let e=this.formattedCurrentPosition;this.formattedLatestData.length&&(e=Z(this.formattedCurrentPosition,this.formattedLatestData)),this.calcLabel(e),this.calcMainTooltip(e),this.mapWidget?.map?.map&&(this.mapWidget.map.updateFromData(!0,e,this.formattedInterpolatedTimeData,i=>{this.activeTrip=i,this.timeUpdated(this.currentTime),this.cd.markForCheck()}),this.settings.showPoints&&this.mapWidget.map.updatePoints(this.formattedInterpolatedTimeData,this.calcTooltip))}else this.updatePending=!0}setActiveTrip(){}calculateLastPoints(e,i){let t=Object.keys(e),n=t.findIndex(a=>Number(a)>=i);return n!==-1?Number(t[n])!==i&&n!==0&&n--:n=t.length-1,e[t[n]]}calculateIntervals(){let e=1/0,i=-1/0;if(this.historicalData.forEach(t=>{e=Math.min(t[0].time,e),i=Math.max(t[t.length-1].time,i)}),this.minTime=e,this.maxTime=i,this.historicalData.forEach((t,n)=>{this.interpolatedTimeData[n]=this.interpolateArray(t)}),this.formattedInterpolatedTimeData=this.interpolatedTimeData.map(t=>L.default.values(t)),this.activeTrip||(this.activeTrip=this.interpolatedTimeData.map(t=>t[this.minTime]).filter(t=>t)[0]),this.useAnchors){let t=Object.entries(L.default.union(this.interpolatedTimeData)[0]);this.anchors=t.filter((n,a)=>b(this.settings.parsedPointAsAnchorFunction,[n[1],this.formattedInterpolatedTimeData.map(o=>o[a]),n[1].dsIndex])).map(n=>parseInt(n[0],10))}}calcMainTooltip(e){let i=[];for(let t of e)i.push(this.sanitizer.sanitize(E.HTML,this.calcTooltip(t,e)));this.mainTooltips=i}calcLabel(e){if(this.activeTrip){let i=e[this.activeTrip.dsIndex],t=this.settings.useLabelFunction?b(this.settings.parsedLabelFunction,[i,e,i.dsIndex]):this.settings.label;this.label=this.sanitizer.bypassSecurityTrustHtml(z.parseTemplate(t,i,!0))}}interpolateArray(e){let i={},t=this.settings.latKeyName,n=this.settings.lngKeyName;for(let o of e){let r=o.time,D=this.minTime+Math.ceil((r-this.minTime)/this.normalizationStep)*this.normalizationStep;i[D]=P(m({},o),{minTime:this.minTime!==1/0?(0,H.default)(this.minTime).format("YYYY-MM-DD HH:mm:ss"):"",maxTime:this.maxTime!==-1/0?(0,H.default)(this.maxTime).format("YYYY-MM-DD HH:mm:ss"):"",rotationAngle:this.settings.rotationAngle})}let a=Object.keys(i);for(let o=0;o<a.length-1;o++){if(d(i[a[o+1]][t])||d(i[a[o+1]][n])){for(let r=o+2;r<a.length-1;r++)if(T(i[a[r]][t])||T(i[a[r]][n])){let D=A(Number(a[o]),Number(a[r]),Number(a[o+1]));i[a[o+1]]=m(m({},F(i[a[o]],i[a[r]],t,n,D)),i[a[o+1]]);break}}i[a[o]].rotationAngle+=st(i[a[o]],i[a[o+1]],t,n)}return i}calculateCurrentTime(e,i){return e!==this.minTime||i!==this.maxTime?this.minTime>=this.currentTime||d(this.currentTime)?this.minTime:this.maxTime<=this.currentTime?this.maxTime:this.minTime+Math.ceil((this.currentTime-this.minTime)/this.normalizationStep)*this.normalizationStep:this.currentTime}clearIncorrectFirsLastDatapoint(e){let i=e.findIndex(this.findFirstHistoricalDataIndexCoordinate);if(i===-1)return[];let t=e.length-1;for(t;t>0;t--)if(this.findFirstHistoricalDataIndexCoordinate(e[t])){t++;break}return i>0||t<e.length?e.slice(i,t):e}static{this.\u0275fac=function(i){return new(i||s)(w(Q),w(G))}}static{this.\u0275cmp=N({type:s,selectors:[["trip-animation"]],viewQuery:function(i,t){if(i&1&&V(pt,5),i&2){let n;K(n=Y())&&(t.mapContainer=n.first)}},inputs:{ctx:"ctx"},decls:10,vars:12,consts:[["map",""],[1,"trip-animation-widget"],["class","trip-animation-label-container",3,"innerHTML",4,"ngIf"],[1,"trip-animation-container","flex","flex-col"],[1,"map"],[1,"trip-animation-info-panel","flex","flex-row"],["class","tooltip-button","mat-mini-fab","","color","primary","aria-label","tooltip",3,"click",4,"ngIf"],[1,"trip-animation-tooltip","md-whiteframe-z4","flex","flex-col"],["style","padding: 10px 0",3,"innerHTML",4,"ngFor","ngForOf"],[3,"settings","minTime","maxTime","step","anchors","useAnchors","timeUpdated",4,"ngIf"],[1,"trip-animation-label-container",3,"innerHTML"],["mat-mini-fab","","color","primary","aria-label","tooltip",1,"tooltip-button",3,"click"],[2,"padding","10px 0",3,"innerHTML"],[3,"timeUpdated","settings","minTime","maxTime","step","anchors","useAnchors"]],template:function(i,t){i&1&&(l(0,"div",1),f(1,lt,1,1,"div",2),l(2,"div",3),_(3,"div",4,0),l(5,"div",5),f(6,ct,3,0,"button",6),h(),l(7,"div",7),f(8,ht,1,1,"div",8),h()(),f(9,dt,1,6,"tb-history-selector",9),h()),i&2&&(c(),p("ngIf",t.settings.showLabel),c(5),p("ngIf",t.settings.showTooltip),c(),R("background-color",t.settings.tooltipColor)("opacity",t.settings.tooltipOpacity)("color",t.settings.tooltipFontColor),j("trip-animation-tooltip-hidden",!t.visibleTooltip),c(),p("ngForOf",t.mainTooltips),c(),p("ngIf",t.historicalData))},dependencies:[q,B,it,et,nt],styles:['@charset "UTF-8";.trip-animation-widget[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;font-size:16px;line-height:24px;display:flex;flex-direction:column}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-label-container[_ngcontent-%COMP%]{height:24px}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]{position:relative;z-index:1;flex:1;width:100%}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .map[_ngcontent-%COMP%]{width:100%;height:100%}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]{position:absolute;top:0;right:0;pointer-events:none}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]{top:0;left:0;width:32px;min-width:32px;height:32px;min-height:32px;margin:2px;line-height:24px;z-index:999}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{width:24px;height:24px}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:inherit;height:inherit}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-tooltip[_ngcontent-%COMP%]{display:flex;overflow:auto;max-height:90%;position:absolute;top:30px;right:0;z-index:1000;padding:5px;background-color:#fff;transition:.3s ease-in-out}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-tooltip-hidden[_ngcontent-%COMP%]{transform:translate(110%)}']})}}return s})(),Ht=gt;export{gt as a,Ht as b};
